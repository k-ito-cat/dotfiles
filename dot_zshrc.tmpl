# ===== Aliases =====
# 1Password CLI サインインコマンドのエイリアス　
alias ops="eval \"\$(op signin)\""

# ===== PATH =====
[ -f "$HOME/.asdf/asdf.sh" ] && . "$HOME/.asdf/asdf.sh"
[ -f "$HOME/.asdf/completions/asdf.zsh" ] && . "$HOME/.asdf/completions/asdf.zsh"

{{ if eq .chezmoi.os "darwin" }}
export PATH="/Applications/Cursor.app/Contents/Resources/app/bin:$PATH"
{{ end }}

{{ if eq .chezmoi.os "linux" }}
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

# bun
export PATH="$HOME/.bun/bin:$PATH"

# goでインストールしたghqのパスを通す
export PATH="$HOME/go/bin:$PATH"

. /home/linuxbrew/.linuxbrew/opt/asdf/libexec/asdf.sh

# Homebrew (Linuxbrew)
if [ -d "/home/linuxbrew/.linuxbrew/bin" ]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{ end }}

# ===== Prompt =====
# カレントディレクトリを表示
export PS1='%~ %# '


# ===== Locale & language =====
export LANG=en_US.UTF-8
export LANGUAGE=en_US:en


# ===== Functions & keybindings =====
# ghq listコマンドをpecoでキーバインド。cursorで開くように設定。
function peco-src () {
  local selected_dir=$(ghq list -p | peco --prompt="repositories >" --query "$LBUFFER")
  if [ -n "$selected_dir" ]; then
    BUFFER="cursor ${selected_dir}"
    zle accept-line
  fi
  zle clear-screen
}
zle -N peco-src
bindkey '^L' peco-src

{{- if eq .chezmoi.os "linux" }}
# Windows の 1Password SSH Agent を WSL から使うためのブリッジ
if grep -qi microsoft /proc/version 2>/dev/null && command -v npiperelay.exe >/dev/null 2>&1; then
  export SSH_AUTH_SOCK="$HOME/.ssh/agent.sock"

  wsl_restart_ssh_bridge() {
    rm -f "$SSH_AUTH_SOCK"
    ~/.local/bin/1pass-ssh-bridge >/dev/null 2>&1 &
    sleep 0.5
  }

  # ソケットに接続できないまたはエージェントがいない場合はブリッジやり直し
  if ! ssh-add -l >/dev/null 2>&1; then
    wsl_restart_ssh_bridge
  fi
fi
{{ end }}


{{- if eq .chezmoi.os "darwin" }}
# 1Password SSH Agent を ~/.ssh/agent.sock としてエイリアスを張っている。
# ホスト側で SSH_AUTH_SOCK を設定しておかないと、
# devcontainer 起動時に VS Code/Cursor が独自の SSH ソケット
# (/tmp/cursor-remote-ssh-xxxx.sock) を自動で挿入してしまうため、
# ホスト側で先に SSH_AUTH_SOCK を ~/.ssh/agent.sock に固定する。

export SSH_AUTH_SOCK="$HOME/.ssh/agent.sock"
{{- end }}